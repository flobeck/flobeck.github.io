<!DOCTYPE html>
<html>
<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Neural Gas Clock</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="127.0.0.1:4000/neuralgasclock">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">


    <a class="site-title" href="/">flobeck</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Neural Gas Clock</h1>
    <p class="post-meta">Sep 22, 2014</p>
  </header>
  

  <article class="post-content">
  <canvas id="mycanvas" width=100%></canvas>
  <br> <br> <br>
    <p>“Neural gases” are artificial neural networks for vector quantization. They can learn probability distributions or topologies in general. They were first introduced in 1991 by Thomas Martinez and Klaus Schulten, who are researchers in the field of neuroinformatics.
Fast convergence (especially when you are learning a non-static probability distribution as it is the case here) is crucial for applications of vector quantization. As you can see, readability of seconds is an issue. This -of course- can be improved.</p>

<p>The neural gas algorithm is detailed in the original paper<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. In this post, I want to give a short explanation based on this clock.</p>

<p>The (euclidian) topologies which are learned in this case are digits, as displayed by digital clocks using a seven-segment LED display. In my code those segments are implemented as simple lines.
Every digit is made up of <script type="math/tex">N</script> 2-dimensional <strong><em>codebook vectors</em></strong> <script type="math/tex">w_1, w_2, ... ,w_N</script>. These vectors are visualized as the little dots you can see whirling around in the above clock.
Here, the codebook vectors are initialized deterministically (<a href="http://en.wikipedia.org/wiki/Halton_sequence">Halton sequence</a>). Then, a data vector <script type="math/tex">x</script> (i.e. a point situated on one of the line segments of the digit) is chosen randomly. In the following, every single one of the <script type="math/tex">N</script> codebook vectors is adapted to <script type="math/tex">x</script>.</p>

<p>So, how does this adaptation process work exactly?</p>

<p>After a random point <script type="math/tex">x</script> located on a digit is chosen, the distance to <script type="math/tex">x</script> is determined for all codebook vectors <script type="math/tex">w_1, w_2, ... w_N</script>. Next, they are sorted accordingly in ascending order, such that for <script type="math/tex">k=0 \; w_{i_k}</script> is the codebook vector nearest to <script type="math/tex">x</script>. For <script type="math/tex">k=0,...,N-1</script> adaptation is (cf. <sup id="fnref:1:1"><a href="#fn:1" class="footnote">1</a></sup>):</p>

<script type="math/tex; mode=display">\vec{w_i} \longleftarrow \vec{w_i} + \epsilon(t)e^{\frac{-k}{\lambda(t)}}(\vec{w_i^tx^t})</script>

<p>where <script type="math/tex">t</script> increases nonlinearly.</p>

<p>The new position of a “particle” (codebook vector) is computed by adding its old position to a vector pointing from the old position to the data vector <script type="math/tex">x</script> weighted by some time-dependent factors (i.e. functions). In detail:</p>

<script type="math/tex; mode=display">\underbrace{\vec{w_i}}_{\text{new codebook vector}} \longleftarrow \underbrace{\vec{w_i}}_{\text{old codebook vector}} + \underbrace{\epsilon(t)}_{\text{learning rate}} e^{\frac{-k}{\underbrace{\lambda(t)}_{*}}}\underbrace{\vec{w_i^tx^t}}_{\substack{\text{vector from codebook} \\\ \text{vector to data vector}}}</script>

<p><script type="math/tex">*</script> neighbourhood range</p>

<p><br /> <br /> <br /></p>

<p><script type="math/tex">\epsilon(t)</script> and <script type="math/tex">\lambda(t)</script> decay over time:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// using processing(js)</span>

<span class="kd">class</span> <span class="nc">CodebookVector</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">t_max</span> <span class="o">=</span> <span class="mf">500.0</span><span class="o">;</span>

  <span class="n">PVector</span> <span class="n">w</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>         <span class="c1">// index/order (-&gt; e.g. euclidian norm)</span>
  <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">;</span>
  <span class="kt">float</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">;</span>
  <span class="kt">float</span> <span class="n">neighbourhood</span> <span class="o">=</span> <span class="mf">8.0</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">CodebookVector</span><span class="o">(</span><span class="kt">float</span> <span class="n">posx</span><span class="o">,</span> <span class="kt">float</span> <span class="n">posy</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">w</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PVector</span><span class="o">(</span><span class="n">posx</span><span class="o">,</span> <span class="n">posy</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kt">void</span> <span class="nf">changeOrder</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kt">void</span> <span class="nf">resetTime</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">time</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kt">float</span> <span class="nf">eta</span><span class="o">(</span><span class="kt">float</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">*(</span><span class="n">t</span><span class="o">/</span><span class="n">t_max</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kt">float</span> <span class="nf">lambda</span><span class="o">(</span><span class="kt">float</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">neighbourhood</span><span class="o">-</span><span class="n">neighbourhood</span><span class="o">*(</span><span class="n">t</span><span class="o">/</span><span class="n">t_max</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**</span>
<span class="cm">   * change the weight vector/codebook vector w in direction of input</span>
<span class="cm">   * @input: (x y) from prob. distribution</span>
<span class="cm">   **/</span>
   <span class="kt">void</span> <span class="nf">learn</span><span class="o">(</span><span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="kt">float</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">float</span> <span class="n">l</span> <span class="o">=</span> <span class="n">eta</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">t</span><span class="o">)</span> <span class="o">*</span> <span class="n">exp</span><span class="o">(-</span><span class="k">this</span><span class="o">.</span><span class="na">i</span><span class="o">/</span><span class="n">lambda</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">t</span><span class="o">))</span>
    <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">x</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">x</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">y</span> <span class="o">+</span> <span class="n">l</span> <span class="o">*</span> <span class="o">(</span><span class="n">y</span> <span class="o">-</span> <span class="k">this</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">y</span><span class="o">);</span>

    <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">t_max</span><span class="o">*(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">exp</span><span class="o">(-</span><span class="mf">0.012</span><span class="o">*(++</span><span class="k">this</span><span class="o">.</span><span class="na">time</span><span class="o">)));</span> <span class="c1">// t increases nonlinearly</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="o">}</span></code></pre></div>

<p>(A python-version can be found <a href="https://github.com/flobeck/neuralgasclock">here</a>)</p>

<p><br /> <br /> <br /> <br /> <br /> <br /> <br /></p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p><a href="http://www.ks.uiuc.edu/Publications/Papers/PDF/MART91B/MART91B.pdf">A ‘Neural-Gas’ Network Learns Topologies</a> <a href="#fnref:1" class="reversefootnote">&#8617;</a> <a href="#fnref:1:1" class="reversefootnote">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

  </article>

</div>



<script src="https://raw.githubusercontent.com/processing-js/processing-js/v1.4.8/processing.min.js"></script>
<script type="text/processing" data-processing-target="mycanvas">

/**
 * class: CodebookVector 
 * 
 **/
class CodebookVector {
  final float t_max = 500.0;
  
  PVector w;
  int i;         // index/order (-> e.g. euclidian norm)
  float t = 1.0;
  float time = 1.0; 
  float neighbourhood = 10.0;

  public CodebookVector(float posx, float posy, int i) {
    this.i = i;
    this.w = new PVector(posx, posy);
  }

  void changeOrder(int i) {
    this.i = i;
  }

  void resetTime() {
    this.t = 1;
    this.time = 1;
  }

  float eta(float t) { 
    return 1-1*(t/t_max); 
  }

  float lambda(float t) {    
    return neighbourhood-neighbourhood*(t/t_max);
  }
  
  
  /**
   * change the weight vector/codebook vector (posx posy) in direction of input
   * @input: (x y) from prob. distribution
   **/
  void learn(float x, float y) {
    this.w.x = this.w.x + eta(this.t) * exp(-this.i/lambda(this.t)) * (x - this.w.x);
    this.w.y = this.w.y + eta(this.t) * exp(-this.i/lambda(this.t)) * (y - this.w.y);

    this.t = t_max*(1 - exp(-0.012*(++this.time)));
  }


  void display() {
    stroke(0);
    fill(0);
    ellipse(this.w.x, this.w.y, 1, 1);
  }
}




/**
 * Neural Gas Clock  
 * this clock learns something new every second
 * 
 */
static int N = 100;  // number of codebook vectors
PVector[] digitsDistribution = new PVector[6];
int lastTime = 0;
CodebookVector[][] TimeGas = new CodebookVector[6][N];

PVector P(PVector v, int digit, float scale) {
    //assert digit > -1 && digit < 10;  assert does not work in processingjs!
    PVector c1 = new PVector(random(v.x, v.x+scale), v.y);
    PVector c2 = new PVector(v.x, random(v.y, v.y+scale));
    PVector c3 = new PVector(random(v.x, v.x+scale), v.y+scale);
    PVector c4 = new PVector(v.x+scale, random(v.y, v.y+scale));
    PVector c5 = new PVector(v.x, random(v.y+scale, v.y+2*scale));
    PVector c6 = new PVector(random(v.x, v.x+scale), v.y+2*scale);
    PVector c7 = new PVector(v.x+scale, random(v.y+scale, v.y+2*scale));

    switch(digit){ 
    case 0:
      PVector[] zero = {c1,c2,c4,c5,c6,c7};
      return zero[floor(random(0, 5.9))];
    case 1:
     PVector[] one = {c4,c7};
     return one[floor(random(0, 1.9))];
    case 2:
      PVector[] two = {c1,c3,c4,c5,c6};
      return two[floor(random(0, 4.9))];
    case 3:
      PVector[] three = {c1,c3,c4,c6,c7};
      return three[floor(random(0, 4.9))];
    case 4:
      PVector[] four = {c2,c3,c4,c7};
      return four[floor(random(0, 3.9))];
    case 5:
      PVector[] five = {c1,c2,c3,c6,c7};
      return five[floor(random(0, 4.9))];
    case 6:
      PVector[] six = {c1,c2,c3,c5,c6,c7};
      return six[floor(random(0, 5.9))];
    case 7:
      PVector[] seven = {c1,c4,c7};
      return seven[floor(random(0, 2.9))];
    case 8:
      PVector[] eight = {c1,c2,c3,c4,c5,c6,c7};
      return eight[floor(random(0, 6.9))];
    case 9:
      PVector[] nine = {c1,c2,c3,c4,c6,c7};
      return nine[floor(random(0, 5.9))];
    }

    return new PVector(0, 0);
  }



void initCodebookVectors(CodebookVector[] cbv, float posx, float posy, int i) {
  cbv[i] = new CodebookVector(posx, posy, i);
}

float euclid(PVector a, PVector b) { 
  return sqrt(pow(a.x-b.x, 2) + pow(a.y-b.y, 2));
}



// sorts cbv in terms of distance to vec
void sort(CodebookVector[] cbv, PVector vec) {
  boolean unsorted = true;
  while (unsorted) { 
    unsorted = false; 
    for (int i = 0; i<cbv.length-1; i++) {
      if (euclid(cbv[i].w, vec) > euclid(cbv[i+1].w, vec)) {
        CodebookVector tmp = cbv[i];
        cbv[i] = cbv[i+1];
        cbv[i+1] = tmp;
        unsorted = true;
      }
    }
  }
  for (int i = 0; i<cbv.length; i++) {
    cbv[i].changeOrder(i);
  }
}


void newDigit() {
  if (minute()%60 == 0 && hour()%10 == 0) {
    for (int i=0; i < N; i++)
      TimeGas[0][i].resetTime();
  }

  if (minute()%60 == 0 && hour()%10 != 0) {
    for (int i=0; i < N; i++) 
      TimeGas[1][i].resetTime();
  }

  if (minute()%10 == 0 && second()%60 == 0) {
    for (int i=0; i < N; i++) 
      TimeGas[2][i].resetTime();
  } 

  if (second()%60 == 0) { 
    for (int i=0; i < N; i++)
      TimeGas[3][i].resetTime();
  } 

  if (second()%10 == 0) {
    for (int i=0; i < N; i++)
      TimeGas[4][i].resetTime();
  } 


  if (millis() - lastTime >= 1000) {
    for (int i=0; i < N; i++)
      TimeGas[5][i].resetTime(); 

    lastTime = millis();
  }


  for (int i = 0; i < 6; i++) {
    int shift = i*120;
    int scale = 80;
    int d = 0;
    switch(i) {
    case 0: 
      d = (int)floor(hour()/10);
      break;
    case 1: 
      d = hour()%10;
      break;
    case 2: 
      d = (int)floor(minute()/10);
      shift += 50;
      break;
    case 3: 
      d = minute()%10;
      shift += 50;
      break;
    case 4: 
      d = (int)floor(second()/10);
      shift += 100;
      break;
    case 5: 
      d = second()%10;
      shift += 100;
      break;
    }
    digitsDistribution[i] = P(new PVector(20 + shift, 30), d, scale);
  }
}


float halton(float index, float base) {
  float result = 0;
  float f = 1/base;
  float i = index;

  while (i > 0) {
    result = result + f*(i%base);
    i = floor(i/base);
    f = f/base;
  }
  return result;
}



void setup() {
  size(820, 250);
  frameRate(50);


  for (int j = 0; j < 6; j++)
    for (int i = 0; i < N; i++)
      initCodebookVectors(TimeGas[j], halton(i, 2)*(width/6)+j*(width/6), halton(i, 3)*height, i);
}


void draw() {
  background(#FFFFFF);
  newDigit();


  for (int i = 0; i < 6; i++) {
    sort(TimeGas[i], digitsDistribution[i]);
  }



  for (int i=0; i < N; i++) {
    for (int j=0; j < 6; j++) {
      TimeGas[j][i].learn(digitsDistribution[j].x, digitsDistribution[j].y);
    }
  }


  for (int i=0; i < N; i++) {
    for (int j=0; j < 6; j++) {
      TimeGas[j][i].display();
    }
  }

}





</script>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">


    <div class="footer-col-wrapper">


      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/flobeck">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">flobeck</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
